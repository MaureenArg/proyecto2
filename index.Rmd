---
title: "Denuncias Ambientales en Costa Rica"
output: 
  flexdashboard::flex_dashboard:
  orientation: rows
runtime: shiny    
---
  
```{r setup, include=FALSE}
library(flexdashboard)
```

```{r paquetes, warning=FALSE, message=FALSE}
library(dplyr)
library(sf)
library(terra)
library(raster)
library(rgdal)
library(DT)
library(plotly)
library(leaflet)
library(leafem)
library(leaflet.extras)
library(shiny)
library (ggplot2)
library (plotly)
```


```{r datos, warning=FALSE, message=FALSE}

# capa vectorial (GeoJSON) de provincias de Costa Rica
provincias <-
  st_read(
    "https://github.com/tpb728O-programaciongeoespacialr/2021ii/raw/main/datos/ign/delimitacion-territorial-administrativa/provincias.geojson",
    quiet = TRUE
  )
# Transformación del CRS  provincias
provincias <-
  provincias %>%
  st_transform (4326)

```

```{r warning=FALSE, message=FALSE}
# archivo CSV con registros de denuncias
denu_depu <-
  st_read(
    "/vsicurl/https://raw.githubusercontent.com/MaureenArg/datostarea/master/denucdepu.csv",
    options = c(
      "X_POSSIBLE_NAMES=decimalLon",
      "Y_POSSIBLE_NAMES=decimalLat"
    ),
    quiet = TRUE
  )

# Asignación de un CRS a capa denuncias
st_crs (denu_depu) <- 4326

```

```{r}
altitud <-
  rast(
    "/vsicurl/https://raw.githubusercontent.com/tpb728O-programaciongeoespacialr/2021ii/master/datos/worldclim/altitud.tif"
  )
```

```{r}
denuncias2021 <-
read.csv (
  file= "https://raw.githubusercontent.com/MaureenArg/datostarea/master/denunciasoct23.csv", 
 sep = ";"
    )
```

```{r}
asp <-
  st_read(
    "https://raw.githubusercontent.com/tpb728O-programaciongeoespacialr/2021ii/main/datos/sinac/areas-silvestres-protegidas-simplificadas_100m.geojson",
    quiet = TRUE
  )
```

```{r}
red_vial <-
  st_read(
    "https://raw.githubusercontent.com/tpb728O-programaciongeoespacialr/2021ii/main/datos/ign/infraestructura/redvial-simplificadas_500m.geojson",
    quiet = TRUE
  )
```

```{r}
rios <-
  st_read(
    "https://raw.githubusercontent.com/MaureenArg/datostarea/master/rios.geojson",
    quiet = TRUE
  )
```


```{r warning=FALSE, message=FALSE}
# Lista ordenada de denuncias + "Todas"
lista_denuncias <- unique(denu_depu$TIPO_den)
lista_denuncias <- sort(lista_denuncias)
lista_denuncias <- c("Todas", lista_denuncias)

# Lista ordenada de provincias + "Todas"
lista_provincias <- unique(denu_depu$Provincia)
lista_provincias <- sort(lista_provincias)
lista_provincias <- c("Todas", lista_provincias)
```

# Información general 

Column {.sidebar}
-----------------------------------------------------------------------
 
```{r filtros}

h3 ("Filtros")


selectInput(
  inputId = "denuncias",
  label = "Tipo denuncia",
  choices = lista_denuncias,
  selected = "Todas"
)
selectInput(
  inputId = "provincia",
  label = "Provincia",
  choices = lista_provincias,
  selected = "Todas"
)

filtrarRegistros <- reactive({
  # Remoción de geometrías y selección de columnas
  denuncias_filtrado <-
    denu_depu %>%
    dplyr::select(TIPO_den, TIPO_inf, año, Provincia)
  
  # Filtrado de denuncias por tipo
  if (input$denuncias != "Todas") {
    denuncias_filtrado <-
      denuncias_filtrado %>%
      filter(TIPO_den == input$denuncias)
  }
  
  # Filtrado de denuncias por provincia
  if (input$provincia != "Todas") {
    denuncias_filtrado <-
      denuncias_filtrado %>%
      filter(Provincia == input$provincia)
  }
  
  
  
  return (denuncias_filtrado)
})
```
 
 
 
 

Row {data-width=600}
-----------------------------------------------------------------------
  
### Mapa de distribución de denuncias ambientales en Costa Rica (2018-2019)
  
```{r mapa, warning=FALSE}
renderLeaflet({
  registros <-
    filtrarRegistros()
  
  # Conversión del capa altitud a la clase RasterLayer
  altitud_rl <- raster::raster(altitud)
  
  # Mapa Leaflet con capas de provincias y denuncias
  leaflet() %>%
    setView(lng = -84.19452,
            lat = 9.572735,
            zoom = 7) %>%
    addTiles(group = "OSM") %>%
    addProviderTiles("Esri", group = "Esri") %>%
    addRasterImage(altitud_rl,group = "Altitud",
                   opacity = 0.6) %>%
    addPolygons(
      data = provincias,
      color = "red",
      fillColor = "transparent",
      stroke = TRUE, 
      weight = 1.0,
    ) %>%
    addCircleMarkers(
      data = registros, group = "denuncias" , 
      stroke = TRUE,
      radius = 4,
      fillColor = 'red',
      fillOpacity = 1,
      label = paste0(
        registros$denuncias,
        ", ",
        registros$Provincia
        
      ),
      popup = paste0(
        "<strong> Detalle de la Denuncia: </strong>",
        "<em>",
        "<br>",
        registros$TIPO_inf,
        "</em>",
        "<br>",
        "<strong> Tipo de Denuncia: </strong>",
        "<em>",
        "<br>",
        registros$TIPO_den,
        "</em>",
        "<br>",
        "<strong>Provincia: </strong>",
        registros$Provincia,
        "<br>"
        
      )
    ) %>%
    addSearchOSM() %>%
    addResetMapButton() %>%
    addMouseCoordinates () %>%
    addLayersControl(baseGroups = c ("OSM", "Esri", "Altitud", "denuncias"))%>%
    addScaleBar("bottomright")  
}) 
```

  



### Cantidad de denuncias ambientales en Costa Rica en el periodo 2018-2019

```{r grafico}


renderPlotly({
  registros <- filtrarRegistros()
  
  # Gráfico de denuncias ambientales
  registros %>%
    st_drop_geometry() %>%
    group_by(TIPO_den) %>%
    summarize(suma_registros = n()) %>%
    filter(!is.na(TIPO_den))  %>%
    plot_ly(
      x = ~ TIPO_den,
      y = ~ suma_registros,
      type = "bar",
      mode = "markers",
      fill = "tozeroy",
      color = I ("blue")
    ) %>%
    layout(title = "Cantidad de denuncias ambientales en 2018 y 2019", xaxis = list(title = "Tipo de denuncias"),
           yaxis = list(title = "Cantidad de denuncias"))
})


```

Row {data-width=400}
-----------------------------------------------------------------------
  
###  Registros de denuncias ambientales en Costa Rica (2018-2019)
  
  

```{r tabla}
renderDT({
  registros <- filtrarRegistros()
  
  registros %>%
    st_drop_geometry() %>%
    datatable(rownames= FALSE, filter= "top", class= "hover cell-border stripe", colnames = c( "Tipo de denuncia", "Detalle de la denuncia", "Año",  "Provincia"), options = list (language = list (url = "//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json"),pageLength = 15, dom = "Bfrtip"))
})
```

# Gráficos

Row {data-width=300}
-----------------------------------------------------------------------

### Comparación del tipo de denuncias por año

```{r}
Tipos <- c ("Agua", "Aire", "Forestal", "Mineria", "Suelo", "Vida Silvestre" )
año2018 <- c (48,4,25,49,89,41)
año2019 <- c (37,20,47,30,88,56)
data <- data.frame (Tipos, año2018, año2019)
```

```{r}
plot_ly (data, x= ~Tipos, y= ~año2018, type = "bar", name = "2018")%>%
add_trace(y= ~año2019, name= "2019")%>%
layout (yaxis= list(title="Cantidad"), barmode="group")%>%
layout (title= "Cantidad de denuncias ambientales por año", xaxis= list (title= "Tipo de denuncia"), yaxis= list (title= "Cantidad de denuncias"))
```

Row {data-width=300}
-----------------------------------------------------------------------

### Total de denuncias ambientales según tipo (2018-2019)

```{r warning=FALSE, message=FALSE}
denuncias_x_tipo <-
  denuncias2021 %>%
  select (afectado, denuncias) %>%
  group_by (afectado) %>%
  summarise (denuncias = sum (denuncias))
```

```{r warning=FALSE, message=FALSE}
ggplot () + geom_col (
  data = denuncias_x_tipo, 
  aes (x = afectado, fill =  afectado, 
      y = denuncias, fill = "denuncias"), width = 0.9) +
  ggtitle ("Cantidad de denuncias según tipo 2018-2019") +
  xlab ("Tipos de denuncias") +
  ylab ("Cantidad de denuncias") +
  scale_fill_manual (values = c ("#0000FF", "#CDC0B0", "#458B00","#EEAD0E" ,"#8B7355", "#BF3EFF")) +
  theme (
    legend.title = element_blank(), legend.position = "left", plot.title = element_text (size = 13))
```


# Estadísticas 

Row {data-width=300}
-----------------------------------------------------------------------

### Denuncias registradas a una distancia de 1 km de quebradas

```{r}
provincias1 <-
  provincias %>%
  st_transform(crs = 5367)
  
plot(
  provincias1$geometry,
  extent = st_bbox(c(xmin = 280000, xmax = 660000, ymin = 880000, ymax= 1250000)),  
  main = "Quebradas",
  axes = TRUE,
  graticule = TRUE)


quebradas <-
  rios %>%
  filter(TIPO == "QUEBRADA") %>%
  st_transform(crs = 5367)

plot(
  quebradas$geometry,
  add = TRUE,
  col = "blue")

buffer_quebradas <-
  quebradas %>%
  st_buffer (dist = 1000)

denu_depu_crt <-
  denu_depu %>%
  st_transform(crs = 5367)


denuncias_buffer_quebradas <-
  st_join (denu_depu_crt, buffer_quebradas)

plot (
  st_union( buffer_quebradas),
  main = "Denuncias ambientales alrededor de quebradas", 
  axes = TRUE, 
  graticule = TRUE
)  

plot(quebradas$geometry,
     col = "blue",
     add = TRUE)

plot(
  denuncias_buffer_quebradas,
  pch = 16,
  col = "red",
  add = TRUE
)

plot (provincias1$geometry, add= TRUE)

```

Row {data-width=300}
-----------------------------------------------------------------------

### Denuncias ambientales registradas a una distancia de 5 km de autopistas principales


```{r}
autopistas <-
  red_vial %>%
  filter(categoria == "AUTOPISTA")


buffer_autopistas <-
  autopistas %>%
  st_buffer (dist = 5000)


denuncias_buffer_autopistas <-
  st_join (denu_depu_crt, buffer_autopistas)

plot (
  st_union( buffer_autopistas),
  main = "Denuncias ambientales alrededor de autopistas", 
  axes = TRUE, 
  graticule = TRUE
)  

plot (autopistas$geometry, col = "brown", add= TRUE)


plot (denuncias_buffer_autopistas, pch =16, col = "red", add = TRUE)

plot (provincias1, add= TRUE)

```

Row {data-width=300}
-----------------------------------------------------------------------

### Cantidad y tipo de denuncias ambientales cerca de autopistas y quebradas

```{r}
denuncias_buffer_autopistas %>%
  st_drop_geometry () %>%
  filter(!is.na(categoria) & categoria != "") %>%
  group_by(TIPO_inf) %>%
  summarise (registros = n ()) %>%
  arrange (desc(registros)) %>%
  slice (1:10)

denuncias_buffer_quebradas %>%
  st_drop_geometry () %>%
  filter(!is.na(TIPO) & TIPO != "") %>%
  group_by(TIPO_inf) %>%
  summarise (registros = n ()) %>%
  arrange (desc(registros)) %>%
  slice (1:10)
```



